name: Windows RDP Learning Environment (Fixed)

on:
  workflow_dispatch:
    inputs:
      runtime_hours:
        description: 'Runtime in hours (max 6)'
        required: false
        default: '6'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours maximum
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Tailscale
        run: |
          Write-Host "=== Installing Tailscale ===" -ForegroundColor Cyan
          $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          $installerPath = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath -UseBasicParsing
          Start-Process -FilePath $installerPath -ArgumentList "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 10
          Write-Host "[OK] Tailscale installed successfully" -ForegroundColor Green
        shell: powershell

      - name: Connect to Tailscale Network
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "=== Connecting to Tailscale Network ===" -ForegroundColor Cyan
          $tailscalePath = "C:\Program Files\Tailscale\tailscale.exe"
          & $tailscalePath up --authkey="$env:TAILSCALE_AUTHKEY" --hostname="github-runner-rdp"
          
          Start-Sleep -Seconds 5
          $tailscaleIP = & $tailscalePath ip -4
          
          Write-Host "====================================================" -ForegroundColor Yellow
          Write-Host "    TAILSCALE IP: $tailscaleIP" -ForegroundColor Green
          Write-Host "====================================================" -ForegroundColor Yellow
          echo "TAILSCALE_IP=$tailscaleIP" >> $env:GITHUB_ENV
        shell: powershell

      - name: Install and Configure Rclone (DIRECT CREDENTIALS)
        run: |
          Write-Host "=== Installing Rclone ===" -ForegroundColor Cyan
          
          # 1. Download and Install Rclone
          $rcloneUrl = "https://downloads.rclone.org/rclone-current-windows-amd64.zip"
          $zipPath = "$env:TEMP\rclone.zip"
          Invoke-WebRequest -Uri $rcloneUrl -OutFile $zipPath -UseBasicParsing
          Expand-Archive -Path $zipPath -DestinationPath "$env:TEMP\rclone-temp" -Force
          $extractedFolder = (Get-ChildItem "$env:TEMP\rclone-temp" | Select-Object -First 1).FullName
          New-Item -Path "C:\rclone" -ItemType Directory -Force | Out-Null
          Copy-Item -Path "$extractedFolder\rclone.exe" -Destination "C:\rclone\rclone.exe" -Force
          
          # 2. Setup Config Directory
          $rcloneConfigDir = "$env:APPDATA\rclone"
          New-Item -Path $rcloneConfigDir -ItemType Directory -Force | Out-Null
          $configFile = "$rcloneConfigDir\rclone.conf"
          
          # 3. DIRECT CREDENTIALS (NO SECRETS REQUIRED)
          # These are the exact values you provided in the chat
          $clientID = "650970585234-2f4ghsmh8eb81btgbedlhdduh21bgshk.apps.googleusercontent.com"
          $clientSecret = "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"
          $refreshToken = "1//0gRe_ZYuLl8HACgYIARAAGBASNwF-L9IrT7y9R9O_zi2kY2LZyzxVH4OKO9kJVw8gluV6RZmowxgE22hR6cdxf07o8bImTsct4k0"
          
          # 4. Write Config File line-by-line
          Set-Content -Path $configFile -Value "[gdrive2]"
          Add-Content -Path $configFile -Value "type = drive"
          Add-Content -Path $configFile -Value "client_id = $clientID"
          Add-Content -Path $configFile -Value "client_secret = $clientSecret"
          Add-Content -Path $configFile -Value "scope = drive"
          
          # 5. Construct Token JSON
          # We manually build the JSON string to avoid PowerShell parsing errors
          # We use Trim() to ensure no hidden spaces exist
          $tokenJSON = '{"access_token":"","token_type":"Bearer","refresh_token":"' + $refreshToken.Trim() + '","expiry":"2000-01-01T00:00:00.000000000+00:00"}'
          $tokenLine = "token = $tokenJSON"
          Add-Content -Path $configFile -Value $tokenLine
          Add-Content -Path $configFile -Value "team_drive ="
          
          Write-Host "[OK] Rclone config written with direct credentials" -ForegroundColor Green
        shell: powershell

      - name: Mount Google Drive
        run: |
          Write-Host "=== Mounting Google Drive as Z: ===" -ForegroundColor Cyan
          
          # Install WinFsp (Required for mounting)
          $winfspUrl = "https://github.com/winfsp/winfsp/releases/download/v2.0/winfsp-2.0.23075.msi"
          $winfspPath = "$env:TEMP\winfsp.msi"
          Invoke-WebRequest -Uri $winfspUrl -OutFile $winfspPath -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", $winfspPath, "/quiet", "/norestart" -Wait
          
          # Mount Drive
          $logFile = "$env:TEMP\rclone_mount.log"
          Start-Process -FilePath "C:\rclone\rclone.exe" -ArgumentList @(
              "mount", "gdrive2:", "Z:",
              "--volname", "Google Drive",
              "--vfs-cache-mode", "off",
              "--log-file", $logFile,
              "--log-level", "INFO"
          ) -WindowStyle Hidden
          
          # Wait for mount to initialize
          Write-Host "Waiting for Z: drive..."
          Start-Sleep -Seconds 15
          
          if (Test-Path "Z:\") {
              Write-Host "[OK] Google Drive mounted successfully as Z:" -ForegroundColor Green
              Get-ChildItem Z:\ -ErrorAction SilentlyContinue | Select-Object -First 5
          } else {
              Write-Host "[ERROR] Z: drive failed to mount." -ForegroundColor Red
              if (Test-Path $logFile) { Get-Content $logFile -Tail 20 }
              exit 1
          }
        shell: powershell

      - name: Enable and Configure RDP
        run: |
          Write-Host "=== Enabling RDP Access ===" -ForegroundColor Cyan
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Write-Host "[OK] RDP enabled" -ForegroundColor Green
        shell: powershell

      - name: Set RDP Password and Display Info
        run: |
          $password = "Pass@124421sg"
          $username = $env:USERNAME
          net user $username $password
          
          Write-Host ""
          Write-Host "====================================================" -ForegroundColor Magenta
          Write-Host "        RDP CONNECTION INFORMATION" -ForegroundColor Magenta
          Write-Host "====================================================" -ForegroundColor Magenta
          Write-Host "  IP Address:  $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "  Username:    $username" -ForegroundColor Cyan
          Write-Host "  Password:    $password" -ForegroundColor Cyan
          Write-Host "  Z: Drive:    Google Drive (Mounted)" -ForegroundColor Green
          Write-Host "----------------------------------------------------" -ForegroundColor Magenta
          Write-Host "  To SHUTDOWN: Create C:\close.txt file" -ForegroundColor Yellow
          Write-Host "====================================================" -ForegroundColor Magenta
        shell: powershell

      - name: Keep Alive
        run: |
          Write-Host "=== Environment is Running ===" -ForegroundColor Green
          $startTime = Get-Date
          $maxHours = [int]"${{ github.event.inputs.runtime_hours || '6' }}"
          $maxMinutes = $maxHours * 60
          
          while ($true) {
              if (Test-Path "C:\close.txt") {
                  Write-Host "Shutdown signal detected." -ForegroundColor Yellow
                  break
              }
              
              $elapsed = (Get-Date) - $startTime
              if ($elapsed.TotalMinutes -ge $maxMinutes) {
                  Write-Host "Time limit reached." -ForegroundColor Yellow
                  break
              }
              
              Start-Sleep -Seconds 30
          }
        shell: powershell
